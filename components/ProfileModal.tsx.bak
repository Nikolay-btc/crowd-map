"use client";
import React, { useState } from "react";
import { REVIEW_BADGES, findBadge } from "../lib/reviews";
import { getReviewsForUser, addReview, removeReview } from "../lib/profileStore";

export type User = { id: string; name: string; photo: string; rating?: number };

export default function ProfileModal({ user, onClose }: { user: User; onClose: () => void }) {
  const [reviews, setReviews] = useState<string[]>(() => getReviewsForUser(user.id));

  const toggleReview = (id: string) => {
    if (reviews.includes(id)) {
      removeReview(user.id, id);
      setReviews(r => r.filter(x => x !== id));
    } else {
      addReview(user.id, id);
      setReviews(r => [...r, id]);
    }
    document.dispatchEvent(new Event("profile:changed"));
  };

  return (
    <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,.5)", display: "grid", placeItems: "center", zIndex: 1000 }}>
      <div style={{ background: "white", borderRadius: 12, padding: 20, width: 400, maxWidth: "100%", display: "grid", gap: 16 }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <h2>{user.name}</h2>
          <button onClick={onClose}>?</button>
        </div>
        <img src={user.photo} alt={user.name} style={{ width: "100%", height: 220, objectFit: "cover", borderRadius: 8 }} />
        <div>
          <h3>??????</h3>
          <div style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
            {REVIEW_BADGES.map(b => (
              <button key={b.id} onClick={() => toggleReview(b.id)} style={{ border: reviews.includes(b.id) ? "2px solid green" : "1px solid #ddd", borderRadius: 8, padding: "6px 10px", cursor: "pointer", background: reviews.includes(b.id) ? "#eaffea" : "white" }}>
                <span style={{ marginRight: 6 }}>{b.emoji}</span>
                {b.label}
              </button>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}
